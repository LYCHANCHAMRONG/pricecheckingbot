<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Rentals</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Official Telegram WebApp script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color-scheme: light dark; /* Support both light and dark modes */
        }
        /* Style based on Telegram theme */
        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #f3f4f6);
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, #3b82f6);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .btn-secondary {
             background-color: var(--tg-theme-secondary-bg-color, #e5e7eb);
             color: var(--tg-theme-text-color, #111827);
        }
        .hint-text {
            color: var(--tg-theme-hint-color, #6b7280);
        }
    </style>
</head>
<body class="p-4 transition-colors duration-300">

    <!-- Notice for Preview Mode -->
    <div id="notice-container" class="max-w-xl mx-auto mb-4 text-center p-4 rounded-2xl bg-amber-100 text-amber-800 border border-amber-200">
        <h2 class="font-bold">PREVIEW MODE</h2>
        <p class="text-sm">App is running in browser preview. Telegram features are disabled.</p>
    </div>

    <div id="app-container" class="max-w-xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-3xl font-bold">Find Your Next Home</h1>
            <p id="welcome-message" class="hint-text text-sm mt-1">Browse our exclusive listings</p>
        </header>

        <!-- Property Listings -->
        <div id="listings-container" class="space-y-4">
            <h2 class="text-xl font-semibold px-2">Available Rentals</h2>

            <!-- Listing 1 -->
            <div class="card p-4 rounded-2xl shadow-md flex flex-col sm:flex-row gap-4">
                <img src="https://placehold.co/600x400/a7c5fd/ffffff?text=Modern+Apartment" alt="Modern Apartment" class="w-full sm:w-1/3 h-40 object-cover rounded-xl">
                <div class="flex-grow">
                    <h3 class="text-lg font-bold">Modern Downtown Apartment</h3>
                    <p class="hint-text text-sm">Riverside, Phnom Penh</p>
                    <p class="text-lg font-semibold my-2">$1,200 / month</p>
                    <button class="book-btn w-full sm:w-auto btn-primary px-4 py-2 rounded-lg font-semibold transition-transform duration-200 active:scale-95" data-property="Modern Downtown Apartment" data-price="1200">
                        Request Booking
                    </button>
                </div>
            </div>

            <!-- Listing 2 -->
            <div class="card p-4 rounded-2xl shadow-md flex flex-col sm:flex-row gap-4">
                 <img src="https://placehold.co/600x400/d4a7fd/ffffff?text=Cozy+Villa" alt="Cozy Villa" class="w-full sm:w-1/3 h-40 object-cover rounded-xl">
                <div class="flex-grow">
                    <h3 class="text-lg font-bold">Cozy Family Villa</h3>
                    <p class="hint-text text-sm">Toul Kork, Phnom Penh</p>
                    <p class="text-lg font-semibold my-2">$2,500 / month</p>
                     <button class="book-btn w-full sm:w-auto btn-primary px-4 py-2 rounded-lg font-semibold transition-transform duration-200 active:scale-95" data-property="Cozy Family Villa" data-price="2500">
                        Request Booking
                    </button>
                </div>
            </div>
            
            <!-- Listing 3 -->
            <div class="card p-4 rounded-2xl shadow-md flex flex-col sm:flex-row gap-4">
                 <img src="https://placehold.co/600x400/fca7fd/ffffff?text=Studio+Loft" alt="Studio Loft" class="w-full sm:w-1/3 h-40 object-cover rounded-xl">
                <div class="flex-grow">
                    <h3 class="text-lg font-bold">Stylish Studio Loft</h3>
                    <p class="hint-text text-sm">BKK1, Phnom Penh</p>
                    <p class="text-lg font-semibold my-2">$850 / month</p>
                     <button class="book-btn w-full sm:w-auto btn-primary px-4 py-2 rounded-lg font-semibold transition-transform duration-200 active:scale-95" data-property="Stylish Studio Loft" data-price="850">
                        Request Booking
                    </button>
                </div>
            </div>

        </div>

        <!-- Result/Log Display -->
        <div class="card p-6 rounded-2xl shadow-md">
            <h2 class="text-xl font-semibold mb-2">Activity Log</h2>
            <div id="result-container" class="hint-text text-sm font-mono h-24 overflow-y-auto bg-gray-100 dark:bg-gray-800 p-2 rounded-lg">
                <!-- Log will be populated by script -->
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;

            // DOM Elements
            const noticeContainer = document.getElementById('notice-container');
            const appContainer = document.getElementById('app-container');
            const resultContainer = document.getElementById('result-container');
            const welcomeMessage = document.getElementById('welcome-message');
            const bookingButtons = document.querySelectorAll('.book-btn');

            let selectedProperty = null;

            function logEvent(message) {
                const p = document.createElement('p');
                const time = new Date().toLocaleTimeString();
                p.innerHTML = `<span class="text-gray-400">${time}:</span> ${message}`;
                resultContainer.appendChild(p);
                resultContainer.scrollTop = resultContainer.scrollHeight;
            }

            // --- Check if running in Telegram or Browser Preview ---
            const isTelegramEnv = tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length !== 0;

            if (isTelegramEnv) {
                // --- TELEGRAM ENVIRONMENT ---
                noticeContainer.style.display = 'none'; // Hide the preview notice
                try {
                    tg.ready();
                    logEvent('Real estate app is ready (Telegram Env).');
                    tg.setHeaderColor('secondary_bg_color');

                    // --- Personalize Welcome Message ---
                    const user = tg.initDataUnsafe.user;
                    if (user && user.first_name) {
                        welcomeMessage.textContent = `Welcome, ${user.first_name}! Browse our listings below.`;
                    }

                    // --- Main Button for Booking Confirmation ---
                    tg.MainButton.setText('SELECT A PROPERTY TO BOOK');
                    tg.MainButton.disable();

                    tg.MainButton.onClick(() => {
                        if (selectedProperty) {
                            logEvent(`Booking confirmed for: ${selectedProperty.name}`);
                            const dataToSend = JSON.stringify({
                                userId: user.id,
                                userName: user.first_name,
                                property: selectedProperty.name,
                                price: selectedProperty.price,
                                timestamp: new Date().toISOString()
                            });
                            tg.sendData(dataToSend);
                        }
                    });

                } catch (error) {
                    logEvent(`Error: ${error.message}`);
                    appContainer.innerHTML = `<p class="text-red-500">A critical error occurred.</p>`;
                }

            } else {
                // --- BROWSER PREVIEW ENVIRONMENT ---
                logEvent('App is ready (Preview Mode).');
                welcomeMessage.textContent = `Welcome, Guest! Browse our listings below.`;
            }


            // --- Handle Booking Button Clicks (Works in both environments) ---
            bookingButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const propertyName = button.dataset.property;
                    const propertyPrice = button.dataset.price;
                    
                    selectedProperty = { name: propertyName, price: propertyPrice };
                    
                    logEvent(`Selected: ${propertyName}`);
                    
                    if (isTelegramEnv) {
                        // Update Telegram-specific UI
                        tg.HapticFeedback.impactOccurred('light');
                        tg.MainButton.setText(`Confirm Booking for $${propertyPrice}`);
                        if (!tg.MainButton.isVisible) {
                            tg.MainButton.show();
                        }
                        if (!tg.MainButton.isActive) {
                           tg.MainButton.enable();
                        }
                    } else {
                        // Log action for preview mode
                        logEvent(`[PREVIEW] Main button would now show: "Confirm Booking for $${propertyPrice}"`);
                    }
                });
            });
        });
    </script>
</body>
</html>

